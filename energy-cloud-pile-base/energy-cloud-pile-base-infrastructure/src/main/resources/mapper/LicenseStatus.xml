<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.autel.cloud.pile.base.infrastructure.mapper.TbLenBindRelationMapper">
    <update id="updateStatus" parameterType="java.lang.Long">
        UPDATE tb_len_bind_relation
        SET `status` =
        CASE
        WHEN `available_time` &gt; #{currentMills} THEN
        3
        WHEN `unavailable_time` &lt; #{currentMills} THEN
        2
        WHEN `available_time` &lt;  #{currentMills} AND `unavailable_time`  &gt; #{currentMills}
        THEN
        1
        ELSE `STATUS`
        END;
    </update>

    <select id="findLastExpireBindRelation"
            resultType="com.autel.cloud.pile.base.infrastructure.feign.dto.LastExpireBindRelation">

        SELECT pile_sn,tenant_id,service_id, MAX(unavailable_time) as unavailable_time FROM energy_pile_base.tb_len_bind_relation WHERE
        pile_sn in
        <foreach collection="pileSns" separator="," open="(" close=")" item="pileSn">
            #{pileSn}
        </foreach>
        AND tenant_id = #{tenantId}
        <if test="serviceId != '' or serviceId != null">
            AND service_id like  concat('%', #{serviceId},'%')
        </if>
        AND STATUS in (0,1,3)
        AND pile_sn IS NOT NULL GROUP BY service_id, pile_sn, tenant_id
    </select>



    <select id="findLastExpireTime"
            resultType="com.autel.cloud.pile.base.infrastructure.feign.dto.LastExpireTimeDTO">

        SELECT pile_sn, tenant_id, MAX(unavailable_time) as  unavailable_time FROM energy_pile_base.tb_len_bind_relation WHERE
        pile_sn in
        <foreach collection="pileSns" separator="," open="(" close=")" item="pileSn">
            #{pileSn}
        </foreach>
        AND tenant_id = #{tenantId}
        AND pile_sn IS NOT NULL GROUP BY  tenant_id, pile_sn
    </select>

</mapper>
